## SpringBatch - Reference Documentation

### [Spring Batch Introduction](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#spring-batch-intro)
- 엔터프라이즈 도메인은 일반적으로 하기 내용의 작업이 필요하다.
    1. 대량의 정보를 자동화하고, 사용자 상호작용 없이 처리 (일반적으로 시간기반 이벤트에 적용 예) 월말 계산)
    2. 큰 규모에 걸쳐 반복적으로 처리되는 복잡한 비즈니스 규칙의 주기적으로 적용되는 데이터 (보험급여 결정 또는 요율 조정)
    3. 내부 및 외부 시스템에서 수신한 통합 데이터를 일반적으로 형식화, 유효성 확인 및 트랜잭션 방식으로 처리

- 스프링 배치는 엔터프라이즈의 일상적인 운영에 필요한 시스템이다.
- 스프링 배치는 기존에 사용하던 스프링 프레임워크의 개발 접근법으로 개발되어 있다.
- 스프링 배치는 스케줄링 프레임워크가 아니다.

- 스프링 배치가 갖고 있는 대용량 처리 시 필요 한 기능
    1. 재사용 기능
    2. logging / tracing 기능 
    3. Transaction 관리 기능
    4. Job 처리 통계
    5. Job 재시작
    6. Job Skip
    7. Resource 관리

- 추가적인 기능 (대용량 및 고성능 배치 작업)
    1. Optimization
    2. Partitioning

- 스프링 배치를 사용하는 두 가지 방법 (데이터 이동, 변환)
    1. 데이터베이스(Stored Procedure)
    2. 파일

1. [배경](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#springBatchBackground)
    - 소프트웨어 처리 접근 방식, 프레임워크 및 가능한 도구의 표준화
    - 배치 어플리케이션을 생성할 때 엔터프라이트 사용자가 일관되게 활용

2. [시나리오](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#springBatchUsageScenarios)
    - 일반적인 시나리오
        - 데이터베이스, 파일 또는 Queue에서 많은 수의 데이터를 읽기
        - 데이터를 어떤 방식으로 처리할 지
        - 수정된 양식으로 데이터를 다시 쓰기
    
    - 위 기본적인 배치 반복을 자동화하여 처리 기능을 제공한다.
    - 사용자가 없는 오프라인 환경에서의 작업 프로세스 및 트랜잭션 상호 작용 배치 작업이 가능함
    
    - 비즈니스 시나리오
        1. 주기적인 배치 프로세스 커밋
        2. 동시 일괄 처리: 작업의 병렬 처리
        3. 단계별 엔터프라이즈 메시지 기반 처리
        4. 대량 병렬 배치 처리
        5. 실패 후 수동 또는 스케줄에 따른 재시작
        6. 종속 단계의 순차적 처리 (작업 흐름 기반 배치 확장 포함)
        7. 부분 처리: 레코드 건너뛰기(롤백)
        8. 일괄 처리 (작은 사이즈의 케이스 또는 stored procedures/scripts가 있는 경우)
        
    - 기술의 목표
        1. 배치 개발자는 Spring 프로그래밍 모델을 사용하여 프레임워크가 인프라를 관리하도록 하여 비즈니스 로직에 집중할 수 있도록 한다.
        2. 인프라 간의 우려사항과 배치 실행 간의 명확한 분리환경 및 배치 응용 프로그램
        3. 모든 프로젝트가 구현할 수 있는 인터페이스로 공통의 핵심 실행 서비스를 제공
        4. 코어 실행 인터페이스의 단순하고 기본적인 구현체를 제공한다.
        5. 스프링 프레임워크를 활용하여 서비스를 쉽게 커스터마이징 및 확장하여 구성할 수 있다.
        6. 인프라에 영향을 미치지 않고, 기존의 모든 핵심 서비스가 교체 또는 확장이 용이해야 한다.
        7. 메이븐으로 만들어진 어플리케이션으로부터 완전히 분리된 아키텍처 JAR와 배포 모델을 제공한다.

3. [스프링 배치 아키텍처](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#springBatchArchitecture)
    - 확장성과 용이성을 지원하는 계층화된 아키텍처
        - 계층화된 아키텍처는 세 가지 주요 구성요소를 강조한다.
        - Application, Batch Core, Batch Infrastructure
    
        1. Application
            - 모든 배치 작업 및 스프링 배치를 사용하는 개발자에 의해 작성된 사용자 정의 코드를 포함
        2. Batch Core
            - 코어 런타임 클래스와 배치 작업을 시작하고 제어하는 데 필요한 Job, Step, JobLauncher를 구현한 것들을 포함한다.
        3. Batch Infrastructure
            - 공통 readers, writers(ItemReader, ItemWriter와 같은) 그리고 services(RetryTemplate와 같은)를 포함한다. 
    
    ![spring-batch-layers](/docs/batch/img/batch-architecture.png "batchArchitecture")

4. [일반적인 배치 핵심원칙과 가이드라인](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#batchArchitectureConsiderations)
    - 핵심 원칙 및 일반적인 고려사항
        1) 배치 아키텍처는 일반적으로 온라인 아키텍처와 그 반대의 영향을 미치기 때문에 공통 아키텍처를 사용할 때 아키텍처와 환경을 모두 염두하고 설계 해야 한다. 
        2) 단일 배치 어플리케이션에 복잡한 로직 구조를 구축하는 것을 피하고, 가능한 단순화 시켜야 한다.
        3) 데이터의 처리 및 저장을 물리적으로 서로 가깝게 유지한다.
        4) 시스템 리소스 사용을 최소화한다. 특히 I/O, 내부 메모리에 가능한 많은 작업을 수행
        5) 불필요한 물리적 I/O를 피하는 것을 보장할 수 있도록 어플리케이션 I/O(SQL 분석)를 검토한다.
            - 데이터를 한 번 읽고 캐시 또는 저장소에 유지될 때 모든 트랜잭션을 위한 데이터를 읽는 것
            - 이전에 데이터를 읽은 트랜잭션의 데이터를 동일한 트랜잭션에서 다시 읽는 것
            - 테이블 또는 인덱스 스캔을 불필요하게 유발하는 것
            - SQL 문의 Where 절에 키 값을 지정하지 않는 것
        6) 배치를 두 번 실행하지 말아야 한다.
            - 데이터 집계처리를 진행할 때, 최초 처리된 데이터가 있는 경우 저장된 총계를 증가시켜야 한다.
            - 동일한 프로그램이 실행되어 같은 데이터를 다시 처리할 필요가 없다.
        7) 배치 응용 프로그램을 시작할 때 충분한 메모리를 할당하여 시간이 많이 걸리지 않도록 한다.
        8) 데이터 무결성과 관련하여 항상 최악의 상황을 가정한다. 적절한 검사 삽입 및 데이터 무결성을 유지하기 위한 데이터 검증
        9) 가능한 경우 내부 검증을 위한 체크섬을 구현한다.
            - 파일의 총 레코드와 총합이 있는 트레일러 레코드를 가지고 있어야 한다.
        10) 실제 데이터와 같은 데이터로 상용 환경에 가능한 빨리 스트레스 테스트를 계획과 실행한다.
        11) 대규모 배치 시스템에서는 특히 24-7을 기본으로 하는 온라인 시스템에서 실행 중인 경우 백업이 어려울 수 있다.
            - 일반적으로 데이터베이스 백업 관리 온라인 설계의 경우 파일 백업도 마찬가지로 중요하다고 간주해야 한다.
            - 시스템이 파일에 의존하는 경우, 파일 백업 절차는 제자리에 있으면 안된다.
            - 또한 문서화되었지만 정기적으로 테스트되어야 한다.
 
5. [배치 프로세스 전략](https://docs.spring.io/spring-batch/docs/4.2.x/reference/html/spring-batch-intro.html#batchProcessingStrategy)
    - 배치 시스템, 기본 배치 어플리케이션 구성 요소 및 배치 시스템의 설계 및 구현하는데 도움이 되는 것은 설계자와 프로그래머에게 샘플 형태(구조도, 코드, 쉘)로 제공되어야 한다.
    - 배치 작업 설계를 시작할 때 비즈니스 로직을 다음의 내용에 따라 일련의 단계로 분해되어야 한다.
        1. 변환 응용 프로그램(Conversion Applications) 
            - 외부 시스템에 의해 생성되거나 제공되는 파일 타입의 경우, 변환 어플리케이션은 처리가 가능한 표준 형식으로 제공되는 트랜잭션 레코드로 변환해야 한다.
            - 해당 유형의 배치 프로세스 어플리케이션은 부분적으로 또는 전체적으로 변환 유틸리티 모듈로 구성될 수 있다.
        2. 유효성 검사 프로그램(Validation Applications)
            - 검증 어플리케이션으로 모든 입출력 기록은 정확하고 일관됨을 보장한다.
            - 검증은 일반적으로 파일 헤더, trailer, checksum, 및 검증 알고리즘, 레코드 레벨 교차 검색 기반으로 한다.
        3. 추출 응용 프로그램(Extract Applications)
            - 데이터베이스에서 레코드 집합, 입력 파일, 미리 정의된 규칙에 따라 레코드를 읽고, 레코드를 출력 파일을 쓰는 것
        4. 추출 및 수정 응용 프로그램 (Extract/Update Applications)
            - 입력 파일 또는 데이터베이스에서 레코드를 읽고, 각 입력 데이터에서 찾은 데이터에 의해 다루어진 출력 파일 또는 데이터베이스에서 변경하는 것
        5. 처리 및 수정 응용 프로그램 (Processing and Updating Applications)
            - 유효성 검사 또는 추출 프로그램으로부터 입력 트랜잭션에 처리를 수행
            - 일반적인 처리란 처리가 필요한 데이터를 얻기 위해 데이터베이스를 읽는 것, 잠재적으로 데이터베이스를 업데이트 출력 처리를 위한 데이터베이스 및 레코드를 생성하는 것을 포함한다.
        6. 출력 / 형식 응용 프로그램 (Output/Format Applications)
            - 입력 파일을 읽고 표준 포맷에 따른 데이터로부터 데이터를 재구성하는 어플리케이션
            - 또다른 프로그램 또는 시스템으로 전송하거나 인쇄를 위한 출력 파일을 처리하는 어플리케이션
    
    - 각 어플리케이션은 하나 또는 더 많은 표준 유틸리티 단계를 사용하여 만들어야 한다.
        1. Sort
            - 입력 파일을 읽고 기록하는 출력 파일을 생성하는 프로그램 기록 분류 키 필드에 따라 순서를 바꾸었다.
            - 일반적으로 정렬은 표준 시그템 유틸리티에 의해 수행된다.
            
        2. Split
            - 단일 입력 파일을 읽고 각 레코드를 다음 중 하나에 쓰는 프로그램 필드 값에 기반한 여러 출력 파일
            - 표준 시스템 유틸리티에 다루어진 파라미터에 의해 수행되거나 맞춤화 될 수 있다.
        3. Merge
            - 여러 입력 파일에서 레코드를 읽고 입력파일들로부터 결합된 데이터로 하나의 출력파일을 처리하는 것
            - 병합은 변수 기반의 표준 시스템 유틸리티에 의해 수행되거나 맞춤 설계 될 수 있다.

    - 배치 어플리케이션의 입력 소스별 추가분류
        1. 데이터베이스 기반 응용프로그램은 데이터베이스에서 검색된 행 또는 값에 의해 구동
        2. 파일 기반 응용프로그램은 파일에서 검색된 레코드 또는 값으로 구동
        3. 메시지 기반 응용프로그램은 메시지 대기열에서 검색된 메시지에 의해 구동

    - 어떤 배치 시스템의 기초는 처리 전략이다.
        - 전략의 선택하기 위해 영향을 주는 요소
            1. 예상 배치 시스템 볼륨
            2. 동시성을 가진 온라인 시스템 또는 다른 배치 시스템
            3. 사용 가능한 배치 윈도우

        - 배치의 일반적인 처리 옵션 (구현 순서가 증가함에 따른 복잡성)
            1. 오프라인 모드에서 배치 윈도우 동안 정상처리
            2. 동시 배치 또는 온라인 처리
            3. 같은 시간의 작업 또는 다른 배치의 다중 처리를 실행
            4. 파티셔닝 (동시에 동일한 작업의 많은 인스턴스 처리)
            5. 이전 옵션들의 조합
    
    - 위 옵션의 일부 또는 전부를 상업적 스케줄러가 지원할 수 있다.
    - 일괄적으로 채택된 커밋 및 잠금 전략 프로세스는 수행되는 처리 유형과 온라인 잠금에 따라 달라지므로 같은 원칙을 사용해야 한다.
    
    - 잠금 전략은 일반적인 database locks를 사용하거나 아키텍처의 추가적인 Custom locking 서비스를 구현할 수 있다.
    - 잠금 서비스는 데이터베이스를 잠그고 DB를 요청하는 응용프로그램에 권한을 부여하거나 거부할 수 있도록 추적이 가능하다.
    - 또한 이 아키텍처에서 Retry 로직을 구현하여 중단되지 않도록 할 수 있다.
    - 잠금 상황이 발생할 경우 배치 작업을 수행한다.
    
- 전략 예시
    1. Normal processing in a batch window
        - 다른 서비스에 의하여 업데이트되는 데이터가 필요하지 않은 별도의 배치서버에서 실행되는 단순 배치 프로세스의 경우, 
        동시성은 문제가 되지 않으며 배치 실행이 끝나면 단일 커밋을 수행할 수 있다.
        - 배치 시스템은 복잡성과 처리하는 데이터 볼륨 측면에서 시간이 지남에 따라 증가하는 경향이 있다.
        - 잠금 전략이 없고 시스템이 여전히 단일 커밋 포인트에 의존한다면 배치 프로그램을 수정하는 것은 고통스러울 수 있다.
        - 따라서 가장 단순한 배치 시스템을 사용하더라도 복구 옵션을 위한 커밋 로직의 필요성을 고려해야 한다.        
        
    2. Concurrent batch or on-line processing
        - 온라인 배치에서 데이터는 온라인 사용자가 몇초 이상 필요로 할 수 있는 어떤 데이터도 잠그면 안된다.
        - 몇 번의 트랜잭션이 끝날 때마다 업데이트가 데이터베이스에 커밋 되어야 한다.
        - 이런 경우 다른 프로세스에서 사용할 수 없는 데이터 부분과 데이터를 사용할 수 없는 경과 시간이 최소화 된다.

    3. Parallel Processing
    4. Partitioning 
        4.1 Partitioning Approaches
            1. Fixed and Even Break-Up of Record Set
            2. Break up by a Key Column
            3. Breakup by Views
            4. Addition of a Processing Indicator
            5. Extract Table to a Flat File
            6. Use of a Hashing Column
        4.2 Database and Application Design Principles
        4.3 Minimizing Deadlocks
        4.4 Parameter Passing and Validation