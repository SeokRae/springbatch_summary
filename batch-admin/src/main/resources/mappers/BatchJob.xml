<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="BatchJobMapper">

    <!-- 전체 JOB_NAME 별 JOB_INSTANCE LIST 조회 -->
    <select id="SELECT_JOB_INSTANCES_LIST">
        SELECT
            JOB_NAME AS jobName
        FROM BATCH_JOB_INSTANCE
        GROUP BY JOB_NAME
    </select>

    <!-- 특정 JOB_INSTANCE 리스트 조회 -->
    <select id="SELECT_JOB_INSTANCES" parameterType="String" resultType="kr.seok.admin.domain.BatchJobInstance">
        SELECT
            JOB_INSTANCE_ID AS jobInstanceId
            , JOB_NAME AS jobName
            , VERSION AS version
            , JOB_KEY AS jobKey
        FROM BATCH_JOB_INSTANCE
        WHERE 1=1
        AND JOB_NAME = #{jobName}
        ORDER BY JOB_INSTANCE_ID DESC
    </select>

    <select id="SELECT_JOB_EXECUTIONS" parameterType="kr.seok.admin.dto.JobInstanceRequest" resultType="kr.seok.admin.domain.BatchJobExecution">
        SELECT
            B.JOB_INSTANCE_ID AS jobInstanceId
            , B.JOB_NAME AS jobName
            , A.JOB_EXECUTION_ID AS jobExecutionId
            , A.VERSION AS version
            , A.CREATE_TIME AS createTime
            , A.START_TIME AS startTime
            , A.LAST_UPDATED AS lastUpdated
            , A.END_TIME AS endTime
            , A.STATUS AS status
            , A.EXIT_CODE AS exitCode
            , A.EXIT_MESSAGE AS exitMessage
        FROM BATCH_JOB_EXECUTION A
        JOIN BATCH_JOB_INSTANCE B
        ON A.JOB_INSTANCE_ID = B.JOB_INSTANCE_ID
        WHERE 1=1
        AND B.JOB_NAME = #{jobName}
        AND B.JOB_INSTANCE_ID = #{jobInstanceId}
    </select>

    <select id="SELECT_JOB_EXECUTIONS_PARAMS" parameterType="String" resultType="kr.seok.admin.domain.BatchJobExecutionParams">
        SELECT
            JOB_INSTANCE_ID AS jobInstanceId
            , B.JOB_EXECUTION_ID AS jobExecutionId
            , VERSION AS version
            , TYPE_CD AS typeCd
            , KEY_NAME AS keyName
            , STRING_VAL AS stringVal
            , DATE_VAL AS dateVal
            , LONG_VAL AS longVal
            , DOUBLE_VAL AS doubleVal
            , IDENTIFYING AS Identifying
            , CREATE_TIME AS createTime
            , START_TIME AS startTime
            , END_TIME AS endTime
            , LAST_UPDATED AS lastUpdated
            , STATUS AS status
            , EXIT_CODE AS exitCode
            , EXIT_MESSAGE AS exitMessage
        FROM BATCH_JOB_EXECUTION_PARAMS A
        JOIN  BATCH_JOB_EXECUTION B
        ON A.JOB_EXECUTION_ID = B.JOB_EXECUTION_ID
        WHERE 1=1
        AND B.JOB_INSTANCE_ID IN (
                SELECT
                JOB_INSTANCE_ID
                FROM BATCH_JOB_INSTANCE
                WHERE 1=1
                AND JOB_NAME = #{jobName}
            )
        ORDER BY JOB_INSTANCE_ID DESC
    </select>

</mapper>
